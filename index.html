<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Political Axes</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; }
        #container { width: 100vw; height: 100vh; }
        .axis-line { stroke: #888; stroke-width: 1; }
        .axis-label { font-size: 12px; fill: #888; }
    </style>
</head>
<body>
    <div id="container"></div>
    <script>
        const width = window.innerWidth;
        const height = window.innerHeight;

        const svg = d3.select("#container")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        const g = svg.append("g")
            .attr("transform", `translate(${width/2},${height/2})`);

        const scale = d3.scaleLinear()
            .domain([-16, 16])
            .range([-height/2, height/2]);

        let points;
        let rotation = [0, 0];

        // Add axis lines
        const axisData = [
            {axis: 'x', start: [-16, 0, 0], end: [16, 0, 0], label: 'X-axis'},
            {axis: 'y', start: [0, -16, 0], end: [0, 16, 0], label: 'Y-axis'},
            {axis: 'z', start: [0, 0, -16], end: [0, 0, 16], label: 'Z-axis'}
        ];

        const axisLines = g.selectAll(".axis-line")
            .data(axisData)
            .enter()
            .append("line")
            .attr("class", "axis-line");

        const axisLabels = g.selectAll(".axis-label")
            .data(axisData)
            .enter()
            .append("text")
            .attr("class", "axis-label")
            .text(d => d.label);

        // Load data from CSV file
        d3.csv("pros_data.csv").then(data => {
            // Convert string values to numbers
            data.forEach(d => {
                d.x = +d.x;
                d.y = +d.y;
                d.z = +d.z;
            });

            points = g.selectAll("g.point")
                .data(data)
                .enter()
                .append("g")
                .attr("class", "point");

            points.append("image")
                .attr("xlink:href", d => `images/${d.Entity.toLowerCase().replace(/ /g, "_")}.png`)
                .attr("width", 50)
                .attr("height", 50)
                .attr("x", -25)
                .attr("y", -25);

            updatePositions();
            setupDragBehavior();
        }).catch(error => {
            console.error("Error loading the CSV file:", error);
        });

        function updatePositions() {
            points.attr("transform", d => `translate(${scale(d.x)},${scale(d.y)})`);
            updateAxisLines();
        }

        function setupDragBehavior() {
            let dragStartX, dragStartY;

            svg.call(d3.drag()
                .on("start", (event) => {
                    dragStartX = event.x;
                    dragStartY = event.y;
                })
                .on("drag", (event) => {
                    const dx = event.x - dragStartX;
                    const dy = event.y - dragStartY;
                    rotation[0] += dy * 0.005;
                    rotation[1] += dx * 0.005;
                    updateRotation();
                    dragStartX = event.x;
                    dragStartY = event.y;
                })
            );
        }

        function updateRotation() {
            const [rx, ry] = rotation;
            const cosX = Math.cos(rx);
            const sinX = Math.sin(rx);
            const cosY = Math.cos(ry);
            const sinY = Math.sin(ry);

            points.attr("transform", d => {
                const x = d.x * cosY - d.z * sinY;
                const y = d.y * cosX + (d.x * sinY + d.z * cosY) * sinX;
                const z = d.y * -sinX + (d.x * sinY + d.z * cosY) * cosX;
                return `translate(${scale(x)},${scale(y)})`;
            });

            points.sort((a, b) => {
                const az = a.y * -sinX + (a.x * sinY + a.z * cosY) * cosX;
                const bz = b.y * -sinX + (b.x * sinY + b.z * cosY) * cosX;
                return bz - az;
            });

            updateAxisLines();
        }

        function updateAxisLines() {
            const [rx, ry] = rotation;
            const cosX = Math.cos(rx);
            const sinX = Math.sin(rx);
            const cosY = Math.cos(ry);
            const sinY = Math.sin(ry);

            axisLines.attr("x1", d => scale(d.start[0] * cosY - d.start[2] * sinY))
                .attr("y1", d => scale(d.start[1] * cosX + (d.start[0] * sinY + d.start[2] * cosY) * sinX))
                .attr("x2", d => scale(d.end[0] * cosY - d.end[2] * sinY))
                .attr("y2", d => scale(d.end[1] * cosX + (d.end[0] * sinY + d.end[2] * cosY) * sinX));

            axisLabels.attr("x", d => scale(d.end[0] * cosY - d.end[2] * sinY))
                .attr("y", d => scale(d.end[1] * cosX + (d.end[0] * sinY + d.end[2] * cosY) * sinX));
        }
    </script>
</body>
</html>